---
- name: HomeAssistant Config Store
  ansible.builtin.file:
    path: '{{ item }}'
    state: directory
    mode: '0755'
    group: docker
  loop:
    - /yacht/AppData/Config/HomeAssistant/config
    - /yacht/AppData/Config/HomeAssistantMQTT/config
    - /yacht/AppData/Config/HomeAssistantMQTT/data
    - /yacht/AppData/Config/HomeAssistantMQTT/log

- name: HomeAssistant Unitfile
  include_role:
    name: kibatic.docker-systemd
  vars:
    systemd_units:
      - name: homeassistant
        restart_unit: true
        host_copy: []
        image: linuxserver/homeassistant:latest
        network: host
        ports:
          - '8123:8123'
        env:
          TZ: Australia/Adelaide
        volumes:
          - '/yacht/AppData/Config/HomeAssistant/config:/config'
        labels:
          - 'traefik.http.routers.home-assistant-router.rule=Host(\`assistant.home.lan\`)'
          - 'traefik.http.services.home-assistant-service.loadbalancer.server.port=8123'
          - 'traefik.http.routers.home-assistant-router.service=home-assistant-service'
      - name: homeassistant-mosquitto
        restart_unit: true
        host_copy: []
        image: 'eclipse-mosquitto:2.0.12'
        ports:
          - '1883:1883'
          - '9001:9001'
        env:
          TZ: Australia/Adelaide
          PGID: 1000
          PUID: 1000
          UMASK_SET: 000
        volumes:
          - '/yacht/AppData/Config/HomeAssistantMQTT/config/mosquitto.conf:/mosquitto/config/mosquitto.conf'
          - '/yacht/AppData/Config/HomeAssistantMQTT/config/passwd:/mosquitto/config/passwd'
          - '/yacht/AppData/Config/HomeAssistantMQTT/data:/mosquitto/data'
          - '/yacht/AppData/Config/HomeAssistantMQTT/log:/mosquitto/log'
        labels:
          - 'traefik.http.routers.home-assistant-mqtt-router.rule=Host(\`assistant-mqtt.home.lan\`)'
          - 'traefik.http.services.home-assistant-mqtt-service.loadbalancer.server.port=1883'
          - 'traefik.http.routers.home-assistant-mqtt-router.service=home-assistant-mqtt-service'
      - name: homeassistant-zwavejs2mqtt
        restart_unit: true
        host_copy: []
        image: 'zwavejs/zwavejs2mqtt@sha256:b1215c9376c589957d318686040b7b51f372ea13599b42ae05cff1a8d4538f5a'
        ports:
          - '8091:8091'
          - '3000:3000'
        restart: always
        tty: true
        stop_signal: SIGINT
        env:
          TZ: Australia/Adelaide
          PGID: 1000
          PUID: 1000
          UMASK_SET: 000
        volumes:
          - '/yacht/AppData/Config/HomeAssistantZWAVE/store:/usr/src/app/store'
        labels:
          - 'traefik.http.routers.home-assistant-zwave-api-router.rule=Host(\`assistant-zwave-api.home.lan\`)'
          - 'traefik.http.routers.home-assistant-zwave-api-router.service=home-assistant-zwave-api-service'
          - 'traefik.http.services.home-assistant-zwave-api-service.loadbalancer.server.port=3000'
          - 'traefik.http.routers.home-assistant-zwave-ui-router.rule=Host(\`assistant-zwave.home.lan\`)'
          - 'traefik.http.routers.home-assistant-zwave-ui-router.service=home-assistant-zwave-ui-service'
          - 'traefik.http.services.home-assistant-zwave-ui-service.loadbalancer.server.port=8091'
